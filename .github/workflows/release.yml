name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Install pkg
        run: npm install -g pkg

      - name: Create bin directory
        run: mkdir -p bin

      - name: Build binaries for all platforms
        run: |
          pkg dist/cli.js \
            --targets node18-linux-x64,node18-linux-arm64,node18-macos-x64,node18-macos-arm64,node18-win-x64,node18-win-arm64 \
            --output-path bin

      - name: Rename binaries
        run: |
          cd bin
          # pkg outputs: cli-linux, cli-macos, cli-win.exe (and arm64 variants)
          [ -f cli-linux ] && mv cli-linux yakt-linux-x64 || true
          [ -f cli-linux-arm64 ] && mv cli-linux-arm64 yakt-linux-arm64 || true
          [ -f cli-macos ] && mv cli-macos yakt-macos-x64 || true
          [ -f cli-macos-arm64 ] && mv cli-macos-arm64 yakt-macos-arm64 || true
          [ -f cli-win.exe ] && mv cli-win.exe yakt-win-x64.exe || true
          [ -f cli-win-arm64.exe ] && mv cli-win-arm64.exe yakt-win-arm64.exe || true
          
      - name: List built binaries
        run: |
          ls -lh bin/ || true

      - name: Get version from tag
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="dev-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create checksums
        run: |
          cd bin
          for file in yakt-*; do
            if [ -f "$file" ]; then
              sha256sum "$file" > "${file}.sha256"
            fi
          done

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: bin/*
          name: Release v${{ steps.tag.outputs.VERSION }}
          body: |
            ## Yakt v${{ steps.tag.outputs.VERSION }}

            ### Downloads

            **Linux:**
            - [yakt-linux-x64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.tag.outputs.VERSION }}/yakt-linux-x64)
            - [yakt-linux-arm64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.tag.outputs.VERSION }}/yakt-linux-arm64)

            **macOS:**
            - [yakt-macos-x64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.tag.outputs.VERSION }}/yakt-macos-x64)
            - [yakt-macos-arm64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.tag.outputs.VERSION }}/yakt-macos-arm64)

            **Windows:**
            - [yakt-win-x64.exe](https://github.com/${{ github.repository }}/releases/download/v${{ steps.tag.outputs.VERSION }}/yakt-win-x64.exe)
            - [yakt-win-arm64.exe](https://github.com/${{ github.repository }}/releases/download/v${{ steps.tag.outputs.VERSION }}/yakt-win-arm64.exe)

            ### Installation

            After downloading, make the binary executable (Linux/macOS):
            ```bash
            chmod +x yakt-<platform>-<arch>
            sudo mv yakt-<platform>-<arch> /usr/local/bin/yakt
            ```

            Or on Windows, add the directory to your PATH.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

